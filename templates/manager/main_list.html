<table id="manager_list">
    <tr>
        <td></td>
    </tr>
</table>
<div id="manager_pager"></div>
<script type="text/javascript">
    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) == (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                // Only send the token to relative URLs i.e. locally.
                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
            }
        }
    });

    var $manager = $("#manager_list");
    $manager.jqGrid({
        url: "/{{ manager.manager_name }}/actions/?t=json",
        datatype: "json",
        mtype: "GET",
        direction: "rtl",
        recordpos: "left",
        colNames: [
            {% for column in manager.columns %}
                '{{ column.column_verbose_name }}'
                {% if not forloop.last %}
                    ,
                {% endif %}
            {% endfor %}
        ],
        colModel: [
            {% for column in manager.columns %}
                { name: "{{ column.column_name }}", width: '{{ column.column_width }}', align: "right" }
                {% if not forloop.last %}
                    ,
                {% endif %}
            {% endfor %}
        ],
        pager: "#manager_pager",
        rowNum: {{ manager.data_per_page }},
        rowList: [10, 20, 30],
        sortname: "id",
        sortorder: "desc",
        viewrecords: true,
        gridview: true,
        autoencode: true,
        autowidth: true,
        shrinkToFit: true,
        height: 310,
        {% if manager.actions %}
            multiselect: true,
        {% endif %}
        stype: 'select',
        caption: "{{ manager.verbose_name }}",
        {% if manager.actions %}
            toolbar: [true, "top"],
        {% endif %}
        jsonReader: {
            root: "rows",
            page: "page",
            total: "total",
            records: "records",
            repeatitems: true,
            cell: ""
        }
    });
    $manager.jqGrid('navGrid', '#manager_pager',
            {position: "right", edit: false, add: false, del: false, search: false, refresh: true });

    $('.filter-submit').click(function () {
        var new_url = '/{{ manager.manager_name }}/actions/?t=json';
        var serialize_form = $('.filter-form').serialize();
        new_url = new_url + '&' + serialize_form;
        $manager.jqGrid().setGridParam({url: new_url}).trigger("reloadGrid");
        return false;
    });

    {% for action in manager.actions %}
        $('#t_manager_list').append('<button rel="group" data-fancybox-type="iframe" id="action-{{ action.action_name }}" class="manager-action" is_view="{{ action.is_view }}" action_name="{{action.action_name }}" action_width="{{action.width }}" action_height="{{action.height }}" min_count="{{ action.min_count|default:"" }}">{{ action.action_verbose_name }}</button>');
    {% endfor %}
    $('.manager-action').click(function () {
        var selected_items = $manager.jqGrid('getGridParam', 'selarrrow');
        var name = $(this).attr('action_name');
        var is_view = $(this).attr('is_view');
        var width = $(this).attr('action_width');
        var height = $(this).attr('action_height');
        var min_count = $(this).attr('min_count');

        if (min_count && selected_items < parseInt(min_count)) {
            alert('لطفا حداقل' + min_count + ' مورد را انتخاب کنید.');
            return false;
        }

        var url = "/{{ manager.manager_name }}/actions/?t=action&n=" + name + "&i=" + selected_items;

        if (is_view == 'False')
            $.ajax({url: url, method: 'POST',
                success: function (result) {
                    $manager.trigger("reloadGrid");
                }});
        else {
            $('#action-' + name).attr('href', url);
            $('#action-' + name).fancybox({
                helpers: {
                    overlay: {
                        css: {
                            'background': 'rgba(247,253,250, 0.9)',
                            'overflow': 'auto'
                        }
                    }
                },
                padding: 0,
                afterClose: function () {
                    $manager.trigger("reloadGrid");
                },
                minHeight: height,
                width: width
            });
            return true;
        }
        return false;
    });

</script>
